# 2.7. Adding a User Interface (GUI)

## A bit of refactoring

### Making sub-packages for Intent-based Systems and Rendering Systems

```bash
$ tree
.
├── AggressiveBehaviourSystem.kt
├── ClearEventsSystem.kt
├── CollisionSystem.kt
├── intent
│   ├── AnimalSteeringSystem.kt
│   └── KeyboardInputSystem.kt
├── MovementSystem.kt
├── rendering
│   ├── ShapeRenderingSystem.kt
│   └── TilemapRenderingSystem.kt
├── ScareAggressiveAnimalAwaySystem.kt
└── VisibilitySystem.kt

3 directories, 10 files

```

## Creating a Camera Follow Component and System

```kotlin
package com.sophia.farm.ecs.component

import com.badlogic.ashley.core.Component
import com.badlogic.ashley.core.Entity
import ktx.ashley.optionalPropertyFor
import com.badlogic.gdx.utils.Pool

class CameraFollow : Component, Pool.Poolable {


    override fun reset() {
    }

    companion object {
        val Entity.camerafollow by optionalPropertyFor<CameraFollow>()
    }
}

```


```kotlin
package com.sophia.farm.ecs.system.rendering

import com.badlogic.ashley.core.Entity
import com.badlogic.ashley.systems.IteratingSystem
import com.badlogic.gdx.graphics.Camera
import com.sophia.farm.ecs.component.CameraFollow
import com.sophia.farm.ecs.component.Position
import com.sophia.farm.ecs.component.Position.Companion.position
import ktx.ashley.allOf
import ktx.graphics.lerpTo
import ktx.math.vec2

class CameraFollowSystem(
    private val camera: Camera
): IteratingSystem(
    allOf(
        CameraFollow::class,
        Position::class
    ).get()
) {
    val target= vec2()
    override fun processEntity(entity: Entity, deltaTime: Float) {
        val position = entity.position!!

        target.set(position.x.toFloat(), position.y.toFloat())

        camera.lerpTo(target, 0.1f)
        camera.update()
    }
}

```

Plug it in the `installSystems` method of `WorldBuilder`.

Also in `FirstScreen`, make sure that the camera is provided for the `WorldBuilder` to use in the `CameraFollowSystem`.

```kotlin
val worldBuilder = WorldBuilder(random, shapeRenderer, viewport.camera)
```

Can now clean up the `resize` method, too.

```kotlin
override fun resize(width: Int, height: Int) {
        viewport.update(width, height)
    }
```

## Creating a UI System with a Bottom Panel using Scene2D.ui

```kotlin
package com.sophia.farm.ecs.system.rendering

import com.badlogic.ashley.core.Entity
import com.badlogic.ashley.systems.IteratingSystem
import com.badlogic.gdx.Gdx
import com.badlogic.gdx.scenes.scene2d.Stage
import com.badlogic.gdx.scenes.scene2d.actions.Actions
import com.badlogic.gdx.scenes.scene2d.ui.Label
import com.badlogic.gdx.scenes.scene2d.ui.ProgressBar
import com.badlogic.gdx.scenes.scene2d.ui.Value
import com.badlogic.gdx.utils.Align
import com.badlogic.gdx.utils.viewport.Viewport
import com.sophia.farm.ecs.component.Diary.Companion.diary
import com.sophia.farm.ecs.component.Health.Companion.health
import com.sophia.farm.ecs.component.Name
import com.sophia.farm.ecs.component.Name.Companion.name
import com.sophia.farm.ecs.component.Player
import com.sophia.farm.ecs.component.Position
import com.sophia.farm.ecs.component.Position.Companion.position
import com.sophia.farm.ecs.component.event.ClickedOnWorld.Companion.clickedOnWorld
import ktx.actors.txt
import ktx.ashley.allOf
import ktx.math.vec2
import ktx.scene2d.actors
import ktx.scene2d.label
import ktx.scene2d.progressBar
import ktx.scene2d.scene2d
import ktx.scene2d.table
import kotlin.let
import kotlin.math.min

class HUDSystem(
    val worldViewport: Viewport
): IteratingSystem(
    allOf(
        Player::class
    ).get()
) {
    val playerHealthBar: ProgressBar
    val diaryLabels: List<Label>
    val stage = Stage().apply {
        actors {
            table {
                setFillParent(true)
                defaults().pad(10f)
                table {
                    it.grow()
                }
                row()
                // bottom panel
                table {
                    it.growX().minHeight(Value.percentHeight(0.25f, parent))
                    defaults().pad(5f)
                    background = skin.getDrawable("window")
                    table {
                        it.growX()
                        this.defaults().align(Align.left).growX()
                        label("Health: ")
                        playerHealthBar = progressBar(0f, 1f, 0.1f) {
                            it.minWidth(Value.percentWidth(0.5f, parent))
                            it.minHeight(Value.percentHeight(0.1f, parent))
                        }
                    }
                    row()
                    table {
                        it.growX()
                        this.defaults().align(Align.left).growX()
                        diaryLabels = buildList {
                            for (i in 0 until 5){
                                add(label(" "))
                                row()
                            }
                        }

                    }
                }
            }
        }
    }

    override fun update(deltaTime: Float) {
        super.update(deltaTime)

        stage.viewport.apply()
        stage.act()
        stage.draw()
    }

    override fun processEntity(entity: Entity, deltaTime: Float) {
        
    }
}


```


```kotlin
package com.sophia.farm.ecs.factory

.... (imports)

class WorldBuilder(
    private val random: Random,
    private val shapeRenderer: ShapeRenderer
) {

     ... (code omitted)

    private fun installSystems(engine: PooledEngine) {
        ... (code omitted)
        engine.addSystem(TilemapRenderingSystem(shapeRenderer))
        engine.addSystem(ShapeRenderingSystem(shapeRenderer))
        engine.addSystem(HUDSystem())
        engine.addSystem(ClearEventsSystem())
    }
}


```

In `FirstScreen`:

```kotlin
override fun resize(width: Int, height: Int) {
        viewport.update(width, height)
        engine[HUDSystem::class]?.stage?.viewport?.update(width, height)
    }
```

In `JackTheFarmer`:

```kotlin
package com.sophia.farm

... (imports)

class JackTheFarmer : KtxGame<KtxScreen>() {
    override fun create() {
        KtxAsync.initiate()
        Scene2DSkin.defaultSkin = Skin("ui/uiskin.json".toInternalFile())

        addScreen(FirstScreen(this))
        setScreen<FirstScreen>()
    }
}


```


## Showing Player Health bar

When defining `Stage` in `HUDSystem`:

```kotlin
    val playerHealthBar: ProgressBar
    val stage = Stage().apply{ 
        actors{
            .... (code omitted)
    // bottom panel
    table {
        it.growX().minHeight(Value.percentHeight(0.25f, parent))
        defaults().pad(5f)
        background = skin.getDrawable("window")
        table {
            it.growX()
            this.defaults().align(Align.left).growX()
            label("Health: ")
            playerHealthBar = progressBar(0f, 1f, 0.1f) {
                it.minWidth(Value.percentWidth(0.5f, parent))
                it.minHeight(Value.percentHeight(0.1f, parent))
            }
        }
    }
    .... (code omitted)
    }
}
```

THen in the `processEntity` method of `HUDSystem`:

```kotlin
override fun processEntity(entity: Entity, deltaTime: Float) {
        val health = entity.health!!
        playerHealthBar.value = health.health.toFloat() / health.maxHealth
    }
```

## Logging Messages on bottom panel

### Adding a Diary component to Jack

```kotlin
package com.sophia.farm.ecs.component

... (code omitted)

class Diary : Component, Pool.Poolable {

    var messages = mutableListOf<String>()

    override fun reset() {
        messages.clear()
    }

    companion object {
        val Entity.diary by optionalPropertyFor<Diary>()
    }
}

```

Then add the component to the `player` in `EntityFactory` as usual.


### Logging animal attacks to the Diary

TODO HERE/ Code ready

### Logging player scaring away animals

### Showing the last diary messages in the bottom panel


## Clicking on entities and retrieving their name

- Create the intent: WantsToSeeName component
- Create the system: TouchWorldSystem
- Make the HUDSystem listen to the intent

## Wrapping up